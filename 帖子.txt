贫民级的法拉利--历时两月从零开始精心自制stm32开发板（附翔实资料）

昨天论坛出问题，第一次发的贴全没了，只能重发一次了，哎，码了这么多字，只能重新码字排图编辑了，哎
发帖不容易，费时费力，第二次重新码字再发更不容易，麻烦大家赏点m币以抚慰受伤的心灵

话说事情起因是一元钱的pos机造成的，记得当初撸的第一个pos机是米刷的，然后就拆了gd32的单片机下来玩，焊在转接板上使用，100脚的转接板，插线很是的困难，经常插错线，还拿着程序调半天没结果。
后来又撸了几个即付宝，里面是stm32的单片机，不想忍受原装板子上基本上所有引脚都没引出，用不了，功能强大的stm32就是个残废，还不如个51，拆下来上转接板又难插线，心塞。
之前想加个小组织，说只会点51被人家鄙视说一点8位单片机搞不了什么大东西，所以想学stm32，看看芯片价格，tm一片（stm32）价格更比3片（51）强，在看看最小系统，tm价格又翻了三倍，开发板更贵了，穷学生伤不起。
正好这个寒假又自学了ad，画了一两个板子，自我感觉还好（其实现在看看一塌糊涂）。
于是在有天出去散步时就萌生了自己做块stm32开发板的想法，计算下感觉蛮合适的，单片机一块钱，板子打样5-6块，其他零件不超20，和起来还比一块最小系统便宜，越想越激动，散步都忙不急看风景了，回来就赶紧研究。
 
最终选择了以正点原子的板子为基础进行改造，这样有个好处，人家电路经过研究肯定没问题，比自己到处找简单，如果引脚差不多一样，程序也可以直接拿过来用，基本不用改，原子的例程，论坛的用这板子的大神的东西，都可以借鉴，同时也加了些玩51的时带不起来的遗憾的东西进去，比如iis、sdio式的sd卡接口、板载stlink（自己没有stlink，买还要钱，不如板载个吧，这样用起了更方便)、也加了平时很难焊接的esp8266焊盘。
这样一加这么多功能发觉，我去，io不够了，想来想去，特别烦躁的过过了两天，想了杜邦线连接式开发板（如有些51开发板就这样），想了各种引脚复用，最后一想到时候实际玩的时候要是刚好接在复用引脚上的东西就不能一起hi了，比如spi和iis只能选一个，用屏幕时不能用sdio等等，那是不是挺麻烦的。
最后做出一个重大的艰难的决定，吧屏幕接口扔了，这样不就省了20多个io，想怎么hi怎么hi，hi完还有剩余io，爽。其实还有另一层打算，之前只玩过12864和1602，对彩屏根本不了解，接口也不熟悉，看了好多款屏幕，各种接口都有，很不统一，如果直接照抄原子哥的屏幕接口，到时候搞不好买不到一样的，还只能去它店里剁手一块他定制的屏幕，那不就比两个自制开发板还贵了么？穷学生玩不起，算了，到时候大不了搞点黑白屏或者全部杜邦线连上，low就low点，自用管他的。
 
 
于是就这样，一块板子就做完了（真尼玛说的容易，学ad和stm32入门花了一个月，设计板子用了2周，工厂花了一周，焊接调试查错差不多花了一周，而且这些时间基本上除了正事外整天投入的，连干正事的时候都还经常想着下一步的计划），所以说不容易啊，就此先感谢大家的支持，你们的支持是我第二版的动力
 
先放设计电路图，图片看不清的资料包里面的完整版都有高清大图下载，电路图和pcb也上传ad文件
 这是主电路图
[attachment=7425076]
stlink和其他部分电路图
[attachment=7425075]
 
 
 
这是计划实现的功能：
*stm32f103rxxx
 
*板载stlink
 
*引出所有引脚
 
*ch340自动下载
 
*TJA1050T can接口芯片
 
*CS4344 i2s接口芯片
 
*ESP8266-12f接口并引出所有引脚
 
*sdio接口sd卡槽+spi接口sd卡槽
 
*NRF24l01插口
 
*25Q32 flash芯片
 
*3keys+3leds
 
*ps2+usb+i2c+i2s+dac
 
*三色5050led
 
*板载stlink
 
 
 
 
 
 这里先放设计图
 
总体2d效果
 [attachment=7424700]
顶层丝印
 [attachment=7424699]
底层丝印
[attachment=7424709]
 
顶层布线
[attachment=7424710]
底层布线
[attachment=7424708]
3d效果
 
[attachment=7424707]
[attachment=7424706]
 话说改来改去还是有好多错，惭愧啊，关于错误会在后面说明
 
顺便上张图，这是当时蛋疼的测试环境
相关帖子：飞线大法好 - 利用一元米刷pos机内部单片机|http://bbs.mydigit.cn/read.php?tid=1547587
[attachment=7424817]
 
 
资料下载链接，资料真心很多，100多m，只能上传百度云http://pan.baidu.com/s/1c0YHNxQ 密码: dugc
相关资料更新网站，为这个开发板专门建的，国内访问可能有点慢https://stm32-posystorage.rhcloud.com
 
关于资料的说明
1、完整版带图片，高清大图，比论坛看得爽，核心版没有
2、资料包含原理图pcb，原版例程，修改过兼容本板的程序，亲测有效，各种说明文档，内容比帖子更翔实
 3、改正，资料里面 未验证的sdio程序验证成功，两个都可以用，是我当粗心有个引脚没焊好，重新补焊一下就好了，两个例程都是正常的
 
 
未完不要插楼


 交给工厂制作花了一周的时间，期间既是急切期待也是紧张，不过在这周里还是吧蓝牙模块研究出来了，早知道晚点交付给工厂，就能吧蓝牙模块的焊盘也焊上了
交重磅作业-成功利用一元即付宝pos刷卡器蓝牙模块bm77|http://bbs.mydigit.cn/read.php?tid=1567205


话说包装不错

还带了干燥剂，真空密封包装

铺开看还是挺壮观的

空板正面

空板背面

背面的二维码，指向资料站，也就是每张图片水印上的地址

板子到了就迫不及待的开始焊第一块主控，结果因为心情太急躁，没有好好校正引脚，用的锡也不好，所以焊得一塌糊涂，不少引脚连在一起了，后来换极细的烙铁搞来搞去，连锡问题没解决，还把焊盘给搞飞了，所以最后只能吧这板子称为炮灰板了，功能没问题，外观太丑，以后有什么危险的实验就先让炮灰上

飞了三根线


好丑





在经历了第一次的失败后，正式版决定认真对待了
这次先焊板载stlink部分
因为这部分是直接抄别人的资料，不确定有没有问题，所以先焊了实验，毕竟我没有这么多台即付宝够我炮灰的，还是要节约使用。
话说这stm32f103c8t6好贵阿，一片价格折合8台pos机。
当时本来都不想搞了，但是想想既要调试stm32又要stm8，只用串口下载复杂，不能调试，和51一样麻烦，太累了，想想算了，还是忍痛剁手一片
这次换上好锡，用马蹄，好好对待，看看焊得怎么样？





stlink部分和供电焊好以后的效果
有点遗憾就是晶振位置有点紧凑，只能抬起来一点，不然会短路

关于stlink的说明：
1、建议焊接完成刷入固件后更新到最新版本固件
2、在开发板上刷入固件时，不要耍小聪明，一定要注意供电，建议不要用板载的3.3v稳压芯片供电，用下载器供电，必须必须必须接全3.3v、rx、tx（swd、sck）和gnd，不然会像我一样浪费一下午给stlink烧固件。供电问题表现为：串口下载检测不到芯片，stlink能检测到且下载，但校验不通过，检查发现，大半程序没烧入，呵呵，总体建议串口下载
3、板载stlink和主芯片有两个短接焊盘相连，如果只想下主控就连起来，不想就别连，我倒是没连，用杜邦线连，我要下载的板子多，只有这个stlink。


给stm8下载

这里回答下坛友@jpdd521的几点建议：
“谢谢，顺便我提几点意见及建议。
首先：把STlink独立出来，做板的时候把stlink独立出来，开Vcut一般情况下做板不多收费，多收费的话就画线自己用勾刀切割，然后，stm32F103在POS机里面也有的，只不过是64pin封装，改改针脚是可以用的，所以，最好是直接画成64pin的。
最好是画成Jlink-OB，这样调试小壁虎EFM还有GD以及其他的GWD的都很方便。
然后就是修改已发现问题。
我看好你呦^ ^ ”

之前不做jlink的原因是我有stm8的板子，只有stlink能两个都调试，至于能做成独立的，我也考虑过，但是如果把stlink的小板拿下来以后主板就好变得难看，这个个人不是太喜欢，还有就是自制的jlink调试不了壁虎，之前坛友验证过的，gd可以直接用stlink调试，亲测可用，不过还是谢谢你的建议 


然后就是主控，拆芯片的办法很简单，没风枪的朋友可以试试，没拍得相关的图，就口述下了
准备一根粗细合适的铜丝，吧铜丝（不沾锡就行，漆包线，不锈钢都可以）从引脚下方穿过，铜丝太细容易断，太粗又穿不过去 ，铜丝另外一头折角固定好，在焊盘上堆锡，一边局部加热一边吧铜丝从侧面拉动出来，每一边焊盘都这样搞，一分钟就下来了，这样局部加热对芯片和周边器件损伤都不大。
但是会造成引脚变形需要修一修，据说可能会损害焊盘，我到没出现过，拆了5个pos机的单片机都没问题，屡试不爽。

拆下来后用马蹄沾大量松香清理残锡，马蹄吸一次锡就在海绵上擦一下，沾松香继续
基本清理完

处理松香和初步校准引脚

在原来的焊盘上精较引脚
看起来是焊在什么一样，其实只是较的太正罢了，并没有粘连

精较后结果



然后就开始焊接了，这次焊得不错，看起来和前次不是出自一个师傅之手



买洗板水因为北京两会卖家要避风头不敢发，用75%酒精洗不怎么干净，就不发洗好的照片了，等以后洗漂亮了再发图


全局焊完后
有些还没焊，是有原因的：
暂未测试/未成功内容：
iic，无24l01
iis，代码不会写，暂不测
can，无芯片
ch340自动下载，买零件那天优信缺货，暂无
ps2，座子插不进去，也没相关设备




最后一楼图了，后面是文字了
两块板子合影

有两块板子就可以任性的玩无线透传了，比如说24l01什么的


还有就是一些bug的记录






@benli  
@飞向狙沙  
@jpdd521  
@nihility  
@ynqjzzh
@么有
@huaweiwx
@信徒1102
@杨雪飞
 
 要板子的：
@huaweiwx
咸菜
xiaodaishu
woss1001